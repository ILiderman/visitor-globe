<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Visitor Globe</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #000;
      }
      canvas {
        display: block;
      }
    </style>
  </head>
  <body>
    <!-- Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
    <!-- OrbitControls -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/examples/js/controls/OrbitControls.js"></script>
    <!-- Globe -->
    <script src="https://cdn.jsdelivr.net/npm/three-globe"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <!-- Yandex.Metrika -->
    <script type="text/javascript">
      (function(m, e, t, r, i, k, a) {
        m[i] = m[i] || function() {
          (m[i].a = m[i].a || []).push(arguments)
        };
        m[i].l = 1 * new Date();
        for (var j = 0; j < document.scripts.length; j++) {
          if (document.scripts[j].src === r) {
            return;
          }
        }
        k = e.createElement(t), a = e.getElementsByTagName(t)[0],
          k.async = 1, k.src = r, a.parentNode.insertBefore(k, a)
      })(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

      ym(102315096, "init", {
        clickmap: true,
        trackLinks: true,
        accurateTrackBounce: true
      });
    </script>
    <noscript>
      <div>
        <img src="https://mc.yandex.ru/watch/102315096" style="position:absolute; left:-9999px;" alt="" />
      </div>
    </noscript>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç -->
    <script>
      console.log("üåê Visitor Globe: Supabase + Online Markers");

      // ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
      const supabase = window.supabase.createClient(
        'https://oeeobhhncjeicprutdgf.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9lZW9iaGhuY2plaWNwcnV0ZGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3NDY5MzYsImV4cCI6MjA2NDMyMjkzNn0.YNCQJt7YCfyUC6wQqw-YWI_gsVYcIr3HLEi_X0WGwYo'
      );

      // Three.js —Å—Ü–µ–Ω–∞
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera();
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      camera.position.z = 300;

      const renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      const globe = new ThreeGlobe()
        .globeImageUrl('./earth.jpg') // –ü–æ–º–µ—Å—Ç–∏ earth.jpg —Ä—è–¥–æ–º —Å —ç—Ç–∏–º HTML
        .pointsData([]) // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø—É—Å—Ç–æ
        .pointAltitude(0.02)
        .pointColor(() => 'red');

      scene.add(globe);

      // –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∫–∞–º–µ—Ä—ã
      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableZoom = true;

      // –ê–Ω–∏–º–∞—Ü–∏—è
      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
      animate();

      // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ—á–µ–∫
      async function loadPoints() {
        try {
          const { data, error } = await supabase.from('visits').select('*');
          if (error) throw error;
          console.log("üìå Points loaded", data);
          globe.pointsData(data);
        } catch (err) {
          console.error("‚ö†Ô∏è Failed to load points", err);
        }
      }

      loadPoints();
    </script>
  </body>
</html>
