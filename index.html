<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Visitor Globe</title>
  <style>
    body { margin: 0; overflow: hidden; background: #000; }
    canvas { display: block; }
  </style>
</head>
<body>

<!-- Yandex.Metrika -->
<script type="text/javascript">
(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
m[i].l=1*new Date();
for (var j = 0; j < document.scripts.length; j++) {
  if (document.scripts[j].src === r) return;
}
k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
})(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

ym(102315096, "init", {
  clickmap:true,
  trackLinks:true,
  accurateTrackBounce:true
});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/102315096" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π JS -->
<script type="module">
import * as THREE from 'https://cdn.skypack.dev/three@0.150.1';
import { OrbitControls } from 'https://cdn.skypack.dev/three@0.150.1/examples/jsm/controls/OrbitControls.js';
import ThreeGlobe from 'https://cdn.skypack.dev/three-globe';
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

console.log("üåê Visitor Globe: Supabase + IPwho + –ú–µ—Ç—Ä");

const supabase = createClient(
  'https://oeeobhhncjeicprutdgf.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9lZW9iaGhuY2plaWNwcnV0ZGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3NDY5MzYsImV4cCI6MjA2NDMyMjkzNn0.YNCQJt7YCfyUC6wQqw-YWI_gsVYcIr3HLEi_X0WGwYo'
);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const controls = new OrbitControls(camera, renderer.domElement);
camera.position.z = 300;
controls.update();

const globe = new ThreeGlobe()
  .globeImageUrl('./earth.jpg') // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ earth.jpg –∑–∞–≥—Ä—É–∂–µ–Ω –≤ –∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è!
  .pointAltitude(0.01)
  .pointColor(() => 'red');

scene.add(globe);

// –°–≤–µ—Ç
const ambientLight = new THREE.AmbientLight(0xbbbbbb);
scene.add(ambientLight);
const dirLight = new THREE.DirectionalLight(0xffffff, 0.6);
dirLight.position.set(0, 0, 1);
scene.add(dirLight);

window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

function animate() {
  requestAnimationFrame(animate);
  globe.rotation.y += 0.001;
  controls.update();
  renderer.render(scene, camera);
}

async function loadPoints() {
  try {
    const { data, error } = await supabase
      .from('visits')
      .select('*')
      .order('timestamp', { ascending: false })
      .limit(200);

    if (error) throw error;

    const points = data.map(row => ({
      lat: row.lat,
      lng: row.lng
    }));

    globe.pointsData(points);
    console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ—á–µ–∫: ${points.length}`);
  } catch (err) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ—á–µ–∫:", err);
  }
}

async function logVisitor() {
  try {
    const res = await fetch('https://ipwho.is/');
    const json = await res.json();
    const { latitude, longitude, city, country } = json;

    if (!latitude || !longitude) throw new Error("–ù–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç");

    console.log("üìå –ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å:", city, country);

    // –ó–∞–ø–∏—Å—å –≤ Supabase
    await supabase.from('visits').insert([{ lat: latitude, lng: longitude, city, country }]);

    // –ú–µ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ
    globe
      .labelsData([{ lat: latitude, lng: longitude, text: city }])
      .labelColor(() => 'yellow')
      .labelAltitude(0.02)
      .labelSize(1.2);

  } catch (err) {
    console.error("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è:", err);
  }
}

animate();
logVisitor();
loadPoints();

</script>

</body>
</html>
