<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Visitor Globe</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>
  <div id="globeViz"></div>

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

  <!-- OrbitControls -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js"></script>

  <!-- three-globe -->
  <script src="https://cdn.jsdelivr.net/npm/three-globe@2.26.2/dist/three-globe.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <!-- Yandex.Metrika -->
  <script type="text/javascript">
    (function(m,e,t,r,i,k,a){
      m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
      m[i].l=1*new Date();
      for (var j = 0; j < document.scripts.length; j++) {
        if (document.scripts[j].src === r) { return; }
      }
      k=e.createElement(t),a=e.getElementsByTagName(t)[0],
      k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(102315096, "init", {
      clickmap:true,
      trackLinks:true,
      accurateTrackBounce:true
    });
  </script>

  <!-- App Logic -->
  <script>
    const supabase = supabase.createClient(
      'https://oeeobhhncjeicprutdgf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
    );

    console.log("üì¶ Supabase –≥–æ—Ç–æ–≤");

    const world = Globe()
      .globeImageUrl('https://iliderman.github.io/visitor-globe/earth.jpg')
      .width(window.innerWidth)
      .height(window.innerHeight)
      .backgroundColor('#000')
      .pointsData([]);

    document.getElementById('globeViz').appendChild(world());

    async function addVisitorPoint() {
      try {
        const ipInfo = await fetch('https://ipapi.co/json/').then(res => res.json());
        const { latitude: lat, longitude: lng, city, country_name: country } = ipInfo;

        await supabase.from('visits').insert([{ lat, lng, city, country }]);
        console.log("‚úÖ –ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞:", city, country);

        world.pointsData([{ lat, lng }]);
      } catch (err) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏:", err);
      }
    }

    addVisitorPoint();
  </script>

  <noscript><div><img src="https://mc.yandex.ru/watch/102315096" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
</body>
</html>
