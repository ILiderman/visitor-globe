<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Visitor Globe (CDN)</title>
  <style>
    body { margin: 0; overflow: hidden; background: #000; }
    canvas { display: block; }
  </style>
</head>
<body>

<!-- Yandex.Metrika -->
<script type="text/javascript">
  (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
  m[i].l=1*new Date();
  for (var j = 0; j < document.scripts.length; j++) {
    if (document.scripts[j].src === r) return;
  }
  k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
  })(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

  ym(102315096, "init", {
    clickmap:true,
    trackLinks:true,
    accurateTrackBounce:true
  });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/102315096" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<script type="module">
  import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js';
  import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.150.1/examples/jsm/controls/OrbitControls.js';
  import ThreeGlobe from 'https://cdn.jsdelivr.net/npm/three-globe@2.26.2/dist/three-globe.module.js';
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  console.log("ðŸŒ Visitor Globe: Supabase + IPwho + ÐœÐµÑ‚Ñ€");

  const supabase = createClient(
    'https://oeeobhhncjeicprutdgf.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9lZW9iaGhuY2plaWNwcnV0ZGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3NDY5MzYsImV4cCI6MjA2NDMyMjkzNn0.YNCQJt7YCfyUC6wQqw-YWI_gsVYcIr3HLEi_X0WGwYo'
  );

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
  const renderer = new THREE.WebGLRenderer();
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  const controls = new OrbitControls(camera, renderer.domElement);
  camera.position.z = 300;
  controls.update();

  const globe = new ThreeGlobe()
    .globeImageUrl('./earth.jpg') // Ð£Ð±ÐµÐ´Ð¸ÑÑŒ, Ñ‡Ñ‚Ð¾ earth.jpg Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½ Ð² ÐºÐ¾Ñ€ÐµÐ½ÑŒ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
    .pointAltitude(0.01)
    .pointColor(() => 'red');

  scene.add(globe);

  const ambientLight = new THREE.AmbientLight(0xbbbbbb);
  scene.add(ambientLight);
  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
  directionalLight.position.set(0, 0, 1);
  scene.add(directionalLight);

  function animate() {
    requestAnimationFrame(animate);
    globe.rotation.y += 0.001;
    controls.update();
    renderer.render(scene, camera);
  }

  async function logVisitor() {
    try {
      const res = await fetch('https://ipwho.is/');
      const data = await res.json();
      const { latitude: lat, longitude: lng, city, country } = data;

      console.log("ðŸ“Œ ÐŸÐ¾ÑÐµÑ‚Ð¸Ñ‚ÐµÐ»ÑŒ:", city, country);

      // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² Supabase
      await supabase.from('visits').insert([{ lat, lng, city, country }]);

      // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð³Ð¾Ñ€Ð¾Ð´ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾
      globe.labelsData([{ lat, lng, text: city }])
        .labelColor(() => 'yellow')
        .labelSize(1.2)
        .labelAltitude(0.02);

    } catch (error) {
      console.error("âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° Ð³ÐµÐ¾Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸:", error);
    }
  }

  async function loadPoints() {
    try {
      const { data, error } = await supabase
        .from('visits')
        .select('*')
        .order('timestamp', { ascending: false })
        .limit(200);

      if (error) throw error;

      const points = data.map(row => ({
        lat: row.lat,
        lng: row.lng
      }));

      globe.pointsData(points);
      console.log(`âœ… Ð—Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾ Ñ‚Ð¾Ñ‡ÐµÐº: ${points.length}`);
    } catch (error) {
      console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ‚Ð¾Ñ‡ÐµÐº:", error);
    }
  }

  animate();
  logVisitor();
  loadPoints();

  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
</script>

</body>
</html>
