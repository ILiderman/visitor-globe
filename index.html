<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üåê Visitor Globe + Supabase</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>

  <!-- Yandex.Metrika -->
  <script type="text/javascript">
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();
    for (var j = 0; j < document.scripts.length; j++) {
      if (document.scripts[j].src === r) { return; }
    }
    k=e.createElement(t),a=e.getElementsByTagName(t)[0],
    k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(102315096, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
    });
  </script>
  <noscript><div><img src="https://mc.yandex.ru/watch/102315096" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
  <!-- /Yandex.Metrika -->

</head>
<body>

<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three-globe"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<script>
  console.log("üåê Visitor Globe: Supabase + Online Markers");

  const supabaseUrl = 'https://oeeobhhncjeicprutdgf.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  const renderer = new THREE.WebGLRenderer();
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera();
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  camera.position.z = 300;

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  const globe = new ThreeGlobe()
    .globeImageUrl('https://raw.githubusercontent.com/ILiderman/visitor-globe/main/earth.jpg')
    .pointAltitude(0.02)
    .pointColor(d => d.isOnline ? 'red' : 'orange')
    .labelText(d => d.isOnline ? d.city : '')
    .labelAltitude(0.06)
    .labelSize(1)
    .labelDotRadius(0.3);

  scene.add(globe);

  const ambientLight = new THREE.AmbientLight(0xbbbbbb);
  scene.add(ambientLight);
  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
  directionalLight.position.set(0, 0, 100);
  scene.add(directionalLight);

  async function logVisitorAndRender() {
    try {
      const res = await fetch('https://ipapi.co/json/');
      const data = await res.json();

      console.log("üìå IP Location:", data);

      const visit = {
        lat: data.latitude,
        lng: data.longitude,
        city: data.city,
        country: data.country_name,
        timestamp: new Date().toISOString()
      };

      await supabase.from('visits').insert([visit]);
      console.log("üìå Logged:", data.city, data.country_name);

    } catch (err) {
      console.error("‚ö†Ô∏è IP API error:", err);
    }

    loadAndRender();
  }

  async function loadAndRender() {
    try {
      const { data: visits } = await supabase
        .from('visits')
        .select('*')
        .order('timestamp', { ascending: false })
        .limit(200);

      const now = Date.now();
      const onlineThreshold = 60 * 1000; // 1 –º–∏–Ω—É—Ç–∞

      const points = visits.map(v => ({
        lat: v.lat,
        lng: v.lng,
        city: v.city,
        isOnline: (new Date(v.timestamp).getTime() > now - onlineThreshold)
      }));

      globe.pointsData(points);
    } catch (e) {
      console.error("‚ö†Ô∏è Failed to load visits:", e);
    }
  }

  logVisitorAndRender();
  setInterval(loadAndRender, 30000);

  (function animate() {
    controls.update();
    renderer.render(scene, camera);
    requestAnimationFrame(animate);
  })();
</script>

</body>
</html>
