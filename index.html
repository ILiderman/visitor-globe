
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Visitor Globe</title>
  <style>
    body { margin: 0; overflow: hidden; background-color: black; }
    #globeViz { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; }
  </style>
</head>
<body>
  <div id="globeViz"></div>

  <!-- Yandex.Metrika counter -->
  <script type="text/javascript">
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();
    for (var j = 0; j < document.scripts.length; j++) {
      if (document.scripts[j].src === r) { return; }
    }
    k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(102315096, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
    });
  </script>
  <noscript><div><img src="https://mc.yandex.ru/watch/102315096" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
  <!-- /Yandex.Metrika counter -->

  <!-- Three.js and Three-Globe dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three-globe@2.26.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <script>
    console.log("ðŸŒ Visitor Globe: Supabase + Online Markers");

    // Supabase init
    const supabaseUrl = "https://oeeobhhncjeicprutdgf.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9lZW9iaGhuY2plaWNwcnV0ZGdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3NDY5MzYsImV4cCI6MjA2NDMyMjkzNn0.YNCQJt7YCfyUC6wQqw-YWI_gsVYcIr3HLEi_X0WGwYo";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const EARTH_IMG_URL = "./earth.jpg"; // assuming it's hosted in the same directory

    const globeContainer = document.getElementById("globeViz");
    const world = Globe()(globeContainer)
      .globeImageUrl(EARTH_IMG_URL)
      .backgroundColor("#000000")
      .pointAltitude(0.015)
      .pointColor(() => "#FF5722")
      .labelsData([])
      .labelLat(d => d.lat)
      .labelLng(d => d.lng)
      .labelText(d => d.city)
      .labelSize(() => 1)
      .labelDotRadius(() => 0.3)
      .labelColor(() => "rgba(255, 255, 255, 0.9)")
      .labelResolution(2);

    // Controls
    const controls = world.controls();
    controls.autoRotate = true;
    controls.autoRotateSpeed = 0.3;

    // Get location
    fetch("https://ipapi.co/json/")
      .then(res => res.json())
      .then(async loc => {
        const visitor = {
          lat: loc.latitude,
          lng: loc.longitude,
          city: loc.city,
          country: loc.country_name
        };
        console.log("ðŸ“Œ Visitor location:", visitor);
        await supabase.from("visits").insert([visitor]);
        loadPoints(visitor);
      });

    async function loadPoints(currentVisitor) {
      const { data, error } = await supabase
        .from("visits")
        .select("*")
        .order("timestamp", { ascending: false })
        .limit(200);
      if (error) {
        console.warn("âš ï¸ Failed to load pointsData:", error);
        return;
      }

      const history = data.filter(p => !(p.lat === currentVisitor.lat && p.lng === currentVisitor.lng));
      const points = [...history.map(p => ({ lat: p.lat, lng: p.lng })), currentVisitor];

      world.pointsData(points);
      world.labelsData([currentVisitor]);

      console.log(`âœ… Rendered: ${points.length} points, 1 online`);
    }
  </script>
</body>
</html>
